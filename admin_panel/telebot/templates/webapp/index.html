<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
    <title>–§–æ—Ä–º–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏</title>
    <style>
        :root {
            --bg: #f2f4f7;
            --card: #ffffff;
            --accent: #0088cc;
            --accent-hover: #0073aa;
            --muted: #6b7280;
            --radius: 12px;
            --shadow: 0 6px 22px rgba(9, 30, 66, 0.08);
            --gap: 14px;
            --maxw: 520px;
            --font-size-base: 16px;
        }

        html, body {
            height: 100%;
            margin: 0;
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background: var(--bg);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: var(--font-size-base);
        }

        .wrap {
            min-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: calc(env(safe-area-inset-top) + 18px) 16px calc(env(safe-area-inset-bottom) + 18px);
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: var(--maxw);
            background: var(--card);
            border-radius: 18px;
            padding: 20px;
            box-shadow: var(--shadow);
            box-sizing: border-box;
            transition: transform .12s ease;
        }

        .container:active {
            transform: translateY(1px);
        }

        header.h {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 6px;
        }

        .h .emoji {
            font-size: 28px;
            line-height: 1;
        }

        h2 {
            margin: 0;
            font-size: 18px;
            color: #0f1724;
            font-weight: 600;
        }

        p.subtitle {
            margin: 6px 0 18px 0;
            color: var(--muted);
            font-size: 13px;
        }

        form.fields {
            display: flex;
            flex-direction: column;
            gap: var(--gap);
        }

        label {
            display: block;
            font-size: 13px;
            color: var(--muted);
        }

        input[type="text"],
        textarea {
            width: 100%;
            box-sizing: border-box;
            padding: 12px 14px;
            font-size: 15px;
            border-radius: 10px;
            border: 1px solid #e6e9ee;
            background: transparent;
            outline: none;
            resize: vertical;
            min-height: 44px;
            transition: box-shadow .12s, border-color .12s;
        }

        input:focus, textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 4px 18px rgba(0, 136, 204, 0.12);
        }

        textarea {
            min-height: 110px;
            line-height: 1.4;
        }

        .actions {
            display: flex;
            gap: 12px;
            margin-top: 4px;
            align-items: center;
            flex-direction: column;
        }

        button.send {
            -webkit-tap-highlight-color: transparent;
            width: 100%;
            appearance: none;
            border: 0;
            background: var(--accent);
            color: white;
            padding: 12px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background .12s, transform .06s;
        }

        button.send:hover {
            background: var(--accent-hover);
        }

        button.send:active {
            transform: translateY(1px);
        }

        button.send[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status {
            width: 100%;
            text-align: center;
            font-size: 14px;
            color: var(--muted);
            min-height: 20px;
        }

        .meta {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            align-items: center;
            margin-top: 8px;
            font-size: 13px;
            color: var(--muted);
        }

        @media (max-width: 420px) {
            .container {
                padding: 16px;
                border-radius: 14px;
            }

            h2 {
                font-size: 17px;
            }

            .emoji {
                font-size: 26px;
            }
        }

        @media (min-width: 900px) {
            :root {
                --maxw: 460px;
            }
        }
    </style>
</head>
<body>
<div class="wrap">
    <div class="container" role="region" aria-label="–§–æ—Ä–º–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏">
        <div class="h">
            <div class="emoji">üí¨</div>
            <div style="flex:1">
                <h2>–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</h2>
                <p class="subtitle">–û—Å—Ç–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.</p>
            </div>
        </div>

        <form id="feedbackForm" class="fields" novalidate>

            <div>
                <label for="message">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
                <textarea id="message" name="message" rows="5" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required
                          aria-required="true"></textarea>
            </div>

            <div class="actions">
                <button type="submit" id="sendBtn" class="send" aria-live="polite">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                <div id="status" class="status" role="status" aria-atomic="true"></div>
            </div>

            <div class="meta" aria-hidden="true">
                <span>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±—ã—á–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è</span>
                <small>–ë–µ–∑ —Å–ø–∞–º–∞ ‚úì</small>
            </div>
        </form>
    </div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
    (function () {
        const $ = sel => document.querySelector(sel);
        const form = $('#feedbackForm');
        const sendBtn = $('#sendBtn');
        const statusEl = $('#status');
        const messageEl = $('#message');

        const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
        try {
            tg?.expand?.();
        } catch (e) {
        }

        function autosize(el) {
            el.style.height = 'auto';
            el.style.height = (el.scrollHeight) + 'px';
        }

        messageEl.addEventListener('input', () => autosize(messageEl));
        autosize(messageEl);

        function setStatus(text, isError = false) {
            statusEl.textContent = text;
            statusEl.style.color = isError ? '#b91c1c' : '';
        }

        function validate() {
            const msg = messageEl.value.trim();
            if (!msg) {
                setStatus('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.', true);
                messageEl.focus();
                return false;
            }
            return true;
        }

        form.addEventListener('submit', async (ev) => {
            ev.preventDefault();
            if (!validate()) return;

            const payload = {
                telegram_id: tg?.initDataUnsafe?.user?.id ?? null,
                text: messageEl.value.trim(),
            };

            sendBtn.disabled = true;
            setStatus('‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...');

            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 10000); // 10s

            try {
                const resp = await fetch('https://test.subcore.ru/api/save_answer', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });

                clearTimeout(timeout);

                if (!resp.ok) {
                    const txt = await resp.text().catch(() => null);
                    throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª ' + resp.status + (txt ? (': ' + txt) : ''));
                }

                let body = null;
                try {
                    body = await resp.json();
                } catch (e) {
                }

                setStatus('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
                messageEl.value = '';
                autosize(messageEl);


            } catch (err) {
                console.error(err);
                if (err.name === 'AbortError') {
                    setStatus('‚ùå –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.', true);
                } else {
                    setStatus('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', true);
                }
            } finally {
                sendBtn.disabled = false;
                setTimeout(() => {
                    if (statusEl.textContent.startsWith('‚úÖ')) setStatus('');
                }, 4000);
            }
        });

        if (!tg) {
            console.info('Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —Ñ–æ—Ä–º–∞ –≤—Å—ë —Ä–∞–≤–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç.');
        }
    })();
</script>
</body>
</html>